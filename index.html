<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BARHAT BSDC ‚Äì Expense Tracker</title>
  <style>
    :root{
      --bg1:#020617;--bg2:#020617;--card:#0b1220e6;--glass:#ffffff14;--border:#ffffff22;
      --grad1:#22c55e66;--grad2:#06b6d466;--grad3:#6366f166;--grad4:#a855f766;
      --pink:#ec4899;--cyan:#22d3ee;--emerald:#10b981;--violet:#8b5cf6;--amber:#f59e0b;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{margin:0;min-height:100svh;display:flex;align-items:flex-start;justify-content:center;background:radial-gradient(circle at top,#0f172a,var(--bg1) 60%,#000);color:#fff}

    /* Phone shell */
    .phone{width:390px;max-width:100vw;height:94svh;max-height:860px;background:#0007;border-radius:44px;padding:12px;border:1px solid var(--border);backdrop-filter:blur(18px);box-shadow:0 40px 120px #000c}

    /* App screen */
    .screen{height:100%;background:linear-gradient(180deg,#0b1220f2,#070b16f2);border-radius:32px;padding:18px 16px 40px;overflow-y:auto;border:1px solid #ffffff2a}

    .glass{border-color:rgba(255,255,255,0.28)}
    .total-card{box-shadow:0 0 30px rgba(34,197,94,0.25), inset 0 0 0 1px rgba(255,255,255,0.18)}
    .amount-card{box-shadow:0 0 30px rgba(168,85,247,0.25), inset 0 0 0 1px rgba(255,255,255,0.18)}

    input,select{background:rgba(255,255,255,0.14);border-color:rgba(255,255,255,0.35);color:#e5e7eb}

    select option{color:#0b1220;background:#e5e7eb}
    select:focus option:checked{background:#6366f1;color:#ffffff}

    .sub{color:#cbd5e1}
    .muted{color:#cbd5e1}

    @media (max-width: 480px){
      .phone{width:100vw;height:100svh;max-height:none;border-radius:0;padding:8px}
      .screen{border-radius:20px;padding-bottom:40px}
      h1{font-size:20px}
      button{font-size:15px;padding:12px}
    }

    .screen::-webkit-scrollbar{width:6px}
    .screen::-webkit-scrollbar-thumb{background:#ffffff22;border-radius:10px}

    h1{margin:0;font-size:18px;letter-spacing:.3px}
    .sub{font-size:12px;color:#94a3b8}

    .glass{border-radius:18px;padding:14px;margin-top:12px;border:1px solid var(--border);background:var(--glass);backdrop-filter:blur(10px)}
    .total-card{background:linear-gradient(135deg,var(--grad1),var(--grad2))}
    .amount-card{background:linear-gradient(135deg,var(--grad3),var(--grad4))}

    .row{display:flex;gap:10px}
    .row>*{flex:1}

    input,select,button{width:100%;border-radius:14px;padding:11px 12px;border:1px solid #ffffff22;outline:none;background:#ffffff12;color:#fff;font-size:14px}
    input::placeholder{color:#9ca3af}

    button.primary{background:linear-gradient(90deg,#6366f1,#a855f7,#ec4899);font-weight:800;border:none;box-shadow:0 6px 0 #3b3dbf, 0 10px 25px rgba(0,0,0,0.5);transition:all .15s ease}
    button.primary:active{transform:translateY(4px);box-shadow:0 2px 0 #3b3dbf, 0 6px 12px rgba(0,0,0,0.5)}

    button.secondary{background:linear-gradient(135deg, rgba(34,211,238,0.35), rgba(139,92,246,0.35));border:1px solid rgba(255,255,255,0.35);box-shadow:0 5px 0 rgba(255,255,255,0.25), 0 10px 20px rgba(0,0,0,0.45);transition:all .15s ease}
    button.secondary:active{transform:translateY(4px);box-shadow:0 2px 0 rgba(255,255,255,0.25), 0 6px 12px rgba(0,0,0,0.45)}
    button:hover{filter:brightness(1.15)}

    .footer{text-align:center;font-size:10px;color:#94a3b8;margin:16px 0}
    .hidden{display:none!important}

    .danger{background:#ef44441a;border:1px solid #ef444466}

    .overlay{position:fixed;inset:0;background:#000b;display:flex;align-items:center;justify-content:center;z-index:100}
    .modal{width:280px;background:#0b1220;border-radius:20px;padding:18px;border:1px solid #ef444466;text-align:center}

    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
    .back{width:auto;padding:6px 10px;border-radius:10px}
    .title-sm{font-weight:700;letter-spacing:.3px}

    .history-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:14px;background:#ffffff10;border:1px solid #ffffff22;margin-top:8px}
    .amt{font-weight:700}

    .section-title{margin-top:18px;font-size:13px;font-weight:700;color:#c7d2fe;letter-spacing:.3px}
  </style>
</head>
<body>

<div class="phone">
  <div class="screen">

    <div id="homePage">
      <div id="titleArea">
        <h1 id="appTitle">BARHAT BSDC</h1>
        <div class="sub">Expense Tracker</div>
      </div>

      <div class="glass total-card">
        <div style="font-size:12px;color:#d1fae5">This Month Total</div>
        <div id="monthTotal" style="font-size:28px;font-weight:900;margin-top:4px">‚Çπ 0</div>
      </div>

      <div class="glass amount-card">
        <div style="font-size:12px;color:#e0e7ff">Add Expense</div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:6px">
          <span style="font-size:22px">‚Çπ</span>
          <input id="amountInput" type="number" placeholder="0.00" />
        </div>
      </div>

      <div class="glass">
        <div style="font-size:12px;color:#cbd5f5">Category</div>
        <select id="categoryInput"></select>
      </div>

      <button class="primary" onclick="saveExpense()">Save Expense</button>

      <div class="row" style="margin-top:10px">
        <button class="secondary" onclick="openHistoryPage()">Expense History</button>
        <button class="secondary" onclick="openCategoryPdfPage()">Category PDF</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="secondary" onclick="openAllTotalPdfPage()">All Total PDF</button>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="secondary" onclick="openDeletePage()">Admin Panel</button>
      </div>

      <div class="footer">Made with ‚ù§Ô∏è by Jay</div>
    </div>

    <div id="historyPage" class="hidden">
      <div class="topbar">
        <button class="secondary back" onclick="goHome()">‚Üê</button>
        <div class="title-sm">Expense History</div>
      </div>
      <div class="glass">
        <div class="row">
          <select id="historyMonth"></select>
          <input id="historyYear" type="number" placeholder="Year" />
        </div>
        <button class="secondary" style="margin-top:10px" onclick="renderHistory()">Apply Filter</button>
      </div>
      <div class="section-title">Records</div>
      <div id="historyList"></div>
    </div>

    <div id="categoryPdfPage" class="hidden">
      <div class="topbar">
        <button class="secondary back" onclick="goHome()">‚Üê</button>
        <div class="title-sm">Category PDF</div>
      </div>
      <div class="glass">
        <div style="font-size:12px">Category</div>
        <select id="pdfCategory"></select>
        <div class="row" style="margin-top:10px">
          <select id="pdfMonth"></select>
          <input id="pdfYear" type="number" placeholder="Year" />
        </div>
        <button class="primary" style="margin-top:12px" onclick="generateCategoryPDF()">Generate PDF</button>
      </div>
    </div>

    <div id="allTotalPdfPage" class="hidden">
      <div class="topbar">
        <button class="secondary back" onclick="goHome()">‚Üê</button>
        <div class="title-sm">All Total PDF</div>
      </div>
      <div class="glass">
        <div class="row">
          <select id="allPdfMonth"></select>
          <input id="allPdfYear" type="number" placeholder="Year" />
        </div>
        <button class="primary" style="margin-top:12px" onclick="generateMonthlyPDF()">Generate Monthly PDF</button>
        <button class="secondary" style="margin-top:10px" onclick="generateAbsolutePDF()">Absolute Total PDF</button>
      </div>
    </div>

    <div id="deletePage" class="hidden">
      <div class="topbar">
        <button class="secondary back" onclick="goHome()">‚Üê</button>
        <div class="title-sm">Delete Expense (Admin)</div>
      </div>
      <div class="glass danger">
        <div style="font-size:12px">Category</div>
        <select id="delCategory"></select>
        <div class="row" style="margin-top:10px">
          <select id="delMonth"></select>
          <input id="delYear" type="number" placeholder="Year" />
        </div>
        <div style="margin-top:10px">
          <div style="font-size:12px">Exact Date</div>
          <input id="delDate" type="date" />
        </div>
        <button class="primary" style="background:linear-gradient(90deg,#ef4444,#fb7185)" onclick="deleteSingle()">Delete Expense</button>
        <button class="secondary" style="border:1px solid #ef4444;color:#fecaca;margin-top:8px" onclick="showConfirm()">Delete ALL (Category)</button>
        <div style="font-size:10px;color:#fca5a5;text-align:center;margin-top:8px">Use the Admin Panel button on Home screen to open this page</div>
      </div>
    </div>

    <div id="deleteAllPage" class="hidden">
      <div class="topbar">
        <button class="secondary back" onclick="openDeletePage()">‚Üê</button>
        <div class="title-sm">Delete ALL Expenses</div>
      </div>
      <div class="glass danger">
        <div style="font-size:12px">Select Category</div>
        <select id="delAllCategory"></select>
        <button class="primary" style="background:linear-gradient(90deg,#dc2626,#fb7185);margin-top:12px" onclick="deleteAllByCategory()">Delete ALL</button>
        <div style="font-size:10px;color:#fca5a5;text-align:center;margin-top:6px">This action cannot be undone</div>
      </div>
    </div>

  </div>
</div>

<div id="confirmModal" class="overlay hidden">
  <div class="modal">
    <div style="color:#f87171;font-weight:700">Warning</div>
    <div style="font-size:13px;margin-top:6px">Delete ALL expenses of this category?</div>
    <button class="primary" style="background:#ef4444;margin-top:10px" onclick="confirmDeleteAll()">Yes</button>
    <button class="secondary" style="margin-top:8px" onclick="hideConfirm()">No</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const categories=["Electricity","Electrition","Water","Kamwali","WiFi","Stationary","Rasan","Computer Equipment","Office Rent","Maintenance","Travel","Guddu Toto Rent","Vikash Toto Rent","Petrol","Miscellaneous"];
const months=["January","February","March","April","May","June","July","August","September","October","November","December"];

let expenses=[];
try{expenses=JSON.parse(localStorage.getItem("expenses")||"[]");if(!Array.isArray(expenses))expenses=[]}catch{expenses=[]}

const $=id=>document.getElementById(id);

function showPage(id){
  ["homePage","historyPage","categoryPdfPage","allTotalPdfPage","deletePage","deleteAllPage"].forEach(p=>{const el=$(p); if(el) el.classList.add("hidden");});
  const target=$(id);
  if(target) target.classList.remove("hidden");
  const screen=document.querySelector('.screen'); if(screen) screen.scrollTop=0;
}

// üîß FIX: define openDeletePage to avoid ReferenceError
function openDeletePage(){
  showPage("deletePage");
}

function init(){fillSelects();updateMonthTotal();watchMonthChange();runTests();}

function fillSelects(){
  ["categoryInput","delCategory","delAllCategory","pdfCategory"].forEach(id=>{
    const s=$(id); if(!s) return;
    s.innerHTML="<option value=''>Select</option>"+categories.map(c=>`<option value=\"${c}\">${c}</option>`).join("");
  });
  ["delMonth","pdfMonth","allPdfMonth","historyMonth"].forEach(id=>{
    const s=$(id); if(!s) return;
    s.innerHTML="<option value=''>Month</option>"+months.map(m=>`<option value=\"${m}\">${m}</option>`).join("");
  });
}

function saveExpense(){
  const amt=parseFloat($("amountInput").value);
  const cat=$("categoryInput").value;
  if(!amt||!cat){alert("Amount & category required");return}

  const now=new Date();
  const date=now.toISOString().slice(0,10);
  const time=now.toTimeString().slice(0,5);

  expenses.push({amount:amt,category:cat,date,time});
  localStorage.setItem("expenses",JSON.stringify(expenses));

  $("amountInput").value="";
  $("categoryInput").value="";

  updateMonthTotal();
}

function updateMonthTotal(){
  const n=new Date();const m=n.getMonth(),y=n.getFullYear();
  const t=expenses.filter(e=>{const d=new Date(e.date);return d.getMonth()===m&&d.getFullYear()===y})
    .reduce((s,e)=>s+Number(e.amount||0),0);
  const el=$("monthTotal"); if(el) el.innerText=`‚Çπ ${t.toLocaleString()}`;
}

function watchMonthChange(){let l=new Date().getMonth();setInterval(()=>{const n=new Date().getMonth();if(n!==l){l=n;updateMonthTotal()}},60000)}

function openHistoryPage(){renderHistory();showPage("historyPage")}
function goHome(){showPage("homePage")}
function openCategoryPdfPage(){showPage("categoryPdfPage")}
function openAllTotalPdfPage(){showPage("allTotalPdfPage")}

function renderHistory(){
  const list=$("historyList"); if(!list) return;
  list.innerHTML="";

  const selMonth=$("historyMonth").value;
  const selYear=$("historyYear").value;

  const filtered=expenses.filter(e=>{
    const d=new Date(e.date);
    if(selMonth && months[d.getMonth()]!==selMonth) return false;
    if(selYear && d.getFullYear()!==Number(selYear)) return false;
    return true;
  }).sort((a,b)=>new Date(b.date)-new Date(a.date));

  if(filtered.length===0){
    list.innerHTML="<div class='muted' style='margin-top:12px'>No records found</div>";
    return;
  }

  filtered.forEach(e=>{
    const d=new Date(e.date);
    const item=document.createElement("div");
    item.className="history-item";
    item.innerHTML=`<div><div style=\"font-weight:600\">${e.category}</div><div class=\"muted\">${d.toDateString()} ‚Ä¢ ${e.time}</div></div><div class=\"amt\">‚Çπ ${Number(e.amount).toLocaleString()}</div>`;
    list.appendChild(item);
  });
}

function deleteSingle(){
  const cat=$("delCategory").value,month=$("delMonth").value,year=$("delYear").value,date=$("delDate").value;
  if(!cat||!month||!year||!date){alert("Select all fields");return}
  const mi=months.indexOf(month);
  const b=expenses.length;
  expenses=expenses.filter(e=>{const d=new Date(e.date);return !(e.category===cat&&d.getMonth()===mi&&d.getFullYear()===Number(year)&&e.date===date)});
  localStorage.setItem("expenses",JSON.stringify(expenses));
  alert(`${b-expenses.length} expense deleted`);
  updateMonthTotal();
}

function showConfirm(){ const m=$("confirmModal"); if(m) m.classList.remove("hidden") }
function hideConfirm(){ const m=$("confirmModal"); if(m) m.classList.add("hidden") }
function confirmDeleteAll(){ hideConfirm(); showPage("deleteAllPage") }

function deleteAllByCategory(){
  const cat=$("delAllCategory").value;
  if(!cat){alert("Select category");return}
  const b=expenses.length;
  expenses=expenses.filter(e=>e.category!==cat);
  localStorage.setItem("expenses",JSON.stringify(expenses));
  alert(`${b-expenses.length} expenses deleted from ${cat}`);
  goHome();
}

function generateCategoryPDF(){
  const cat=$("pdfCategory").value;
  const month=$("pdfMonth").value;
  const year=$("pdfYear").value;
  if(!cat||!month||!year){alert("Select category, month & year");return}

  const mi=months.indexOf(month);
  const data=expenses.filter(e=>{
    const d=new Date(e.date);
    return e.category===cat && d.getMonth()===mi && d.getFullYear()===Number(year);
  });

  createInvoicePDF(`Category Report ‚Äì ${cat}`,data);
}

function generateMonthlyPDF(){
  const month=$("allPdfMonth").value;
  const year=$("allPdfYear").value;
  if(!month||!year){alert("Select month & year");return}

  const mi=months.indexOf(month);
  const data=expenses.filter(e=>{
    const d=new Date(e.date);
    return d.getMonth()===mi && d.getFullYear()===Number(year);
  });

  createInvoicePDF(`Monthly Report ‚Äì ${month} ${year}`,data,true);
}

function generateAbsolutePDF(){
  createInvoicePDF("Absolute Expense Report (All Time)",expenses,true);
}

function createInvoicePDF(title,data,groupByCategory=false){
  if(!Array.isArray(data) || data.length===0){alert("No records found for PDF");return}

  const { jsPDF } = window.jspdf;
  const doc=new jsPDF({orientation:"portrait", unit:"mm", format:"a4"});

  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const margin = 12;

  const primary=[99,102,241];
  const accent=[236,72,153];
  const dark=[30,41,59];
  const light=[241,245,249];
  const soft=[248,250,252];

  let y=18;

  doc.setFillColor(...primary);
  doc.rect(0,0,pageWidth,36,"F");
  doc.setFontSize(18);
  doc.setTextColor(255,255,255);
  doc.text("BARHAT BSDC", pageWidth/2, 16, {align:"center"});
  doc.setFontSize(11);
  doc.text("Expense Report", pageWidth/2, 26, {align:"center"});

  y=44;
  doc.setFillColor(...light);
  doc.roundedRect(margin,y-10,pageWidth-margin*2,28,4,4,"F");
  doc.setFontSize(10);
  doc.setTextColor(...dark);
  doc.text(title, margin+6, y);
  doc.text(`Generated: ${new Date().toLocaleDateString()}`, pageWidth-margin, y, {align:"right"});

  let monthLine = "";
  if(title.startsWith("Monthly Report")){
    monthLine = title.replace("Monthly Report ‚Äì"," ").trim();
  } else if(title.startsWith("Category Report")){
    monthLine = "Selected Month";
  } else if(title.startsWith("Absolute Expense Report")){
    monthLine = "All Time";
  }
  if(monthLine){ doc.text(`Month: ${monthLine}`, margin+6, y+10); }

  y += 26;

  doc.setFontSize(12);
  doc.setTextColor(...dark);
  doc.text("Records", margin, y);
  y += 6;

  let total = 0;

  const drawCard = (date, category, amount) => {
    const cardHeight = 22;

    if(y + cardHeight > pageHeight - 20){
      doc.addPage();
      y = 20;
    }

    doc.setFillColor(...soft);
    doc.roundedRect(margin, y, pageWidth-margin*2, cardHeight, 3, 3, "F");

    doc.setFontSize(10);
    doc.setTextColor(...dark);

    if(date){
      doc.text(`Date: ${date}`, margin+4, y+7);
    }

    doc.text(`Category: ${category}`, margin+4, y+13);

    doc.setFontSize(11);
    doc.text(`Rs ${amount}`, pageWidth-margin-4, y+13, {align:"right"});

    y += cardHeight + 4;
  };

  if(groupByCategory){
    const map = {};
    data.forEach(e=>{ map[e.category] = (map[e.category]||0) + Number(e.amount||0); });

    Object.keys(map).forEach(cat=>{
      const amt = Number(map[cat]);
      drawCard("", cat, amt.toString());
      total += amt;
    });
  } else {
    data.forEach(e=>{
      const d = new Date(e.date);
      const dateStr = isNaN(d)?"":d.toISOString().slice(0,10);
      const amt = Number(e.amount||0);
      drawCard(dateStr, e.category, amt.toString());
      total += amt;
    });
  }

  if(y + 24 > pageHeight - 20){ doc.addPage(); y = 20; }

  doc.setFillColor(...accent);
  doc.roundedRect(margin, y, pageWidth-margin*2, 18, 4, 4, "F");
  doc.setFontSize(12);
  doc.setTextColor(255,255,255);
  doc.text("TOTAL SPENT", margin+6, y+11);
  doc.text(`Rs ${total.toString()}`, pageWidth-margin-6, y+11, {align:"right"});

  doc.setFontSize(8.5);
  doc.setTextColor(120,120,120);
  doc.text("BARHAT BSDC ‚Äì Personal Expense Report", pageWidth/2, pageHeight-10, {align:"center"});

  doc.save("barhat-expense-report.pdf");

}

function runTests(){
  const required=["homePage","historyPage","allPdfMonth","historyMonth"];
  const missing=required.filter(id=>!$(id));
  if(missing.length>0){console.error("Missing required elements:",missing);}else{console.log("UI self-test passed ‚úî");}

  // New test: ensure openDeletePage exists
  if(typeof openDeletePage!=="function"){
    console.error("openDeletePage is not defined");
  } else {
    console.log("openDeletePage test passed ‚úî");
  }
}

init();
</script>
</body>
</html>
